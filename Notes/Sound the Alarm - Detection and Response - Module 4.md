# Network traffic and logs using IDS and SIEM tools

## Overview of logs

### The importance of logs

Logs are one of the key ways security professionals detect unusual or malicious activity. A **log** is a record of events that occur within an organization's systems. System activity is recorded in what's known as a log file or commonly called logs.

Logs include details like:

- Date
- Time
- Location
- Action
- Names

Logs allow analysts to build a story and timeline around various event occurrences to understand what exactly happened. This is done through log analysis.

**Log analysis** is the process of examining logs to identify events of interest. Since there are different sources available to get logs, an enormous volume of log data can be generated. It's helpful to be selective in what we log, so that we can log efficiently. Excluding specific data from being logged helps reduce the time spent searching through log data.

SIEM tools provide security professionals with a high-level overview of what happens in a network. SIEM tools do this by first collecting data from multiple data sources. Then, the data gets aggregated or centralized in one place. Finally, the diverse log formats get normalized or converted into a single preferred format.

Siem tools help process large log volumes from multiple data souces in real-time.

Since different types of devices and systems can create logs, there are different log data sources in an environment. These include:

- Network
- System
- Application
- Security
- Authentication

### Best practices for log collection and management

#### Logs

Data sources such as devices generate data in the form of events. A log is a record of events that occur within an organization's systems. Originally, logs served the sole purpose of troubleshooting common technology issues. Today, virtually all computing devices produce some form of logs that provide valuable insights beyond troubleshooting.

Security teams access logs from logging receivers like SIEM tools which consolidate logs to provide a central repository for log data. Security professionals use logs to perform log analysis, which is the process of examining logs to identify events of interest.

##### Types of logs

Depending on the data source, different log types can be produced. Here’s a list of some common log types that organizations should record:

- **Network**: Network logs are generated by network devices like firewalls, routers, or switches.
- **System**: System logs are generated by operating systems like Chrome OS™, Windows, Linux, or macOS®.
- **Application**: Application logs are generated by software applications and contain information relating to the events occurring within the application such as a smartphone app.
- **Security**: Security logs are generated by various devices or systems such as antivirus software and intrusion detection systems. Security logs contain security-related information such as file deletion.
- **Authentication**: Authentication logs are generated whenever authentication occurs such as a successful login attempt into a computer.

##### Log details

Generally, logs contain a date, time, location, action, and author of the action.

Logs contain information and can be adjusted to contain even more information. Verbose logging records additional, detailed information beyond the default log recording.

#### Log management

To get the most value from your logs, you need to choose exactly what to log, how to access it easily, and keep it secure using log management. Log management is the process of collecting, storing, analyzing, and disposing of log data.

##### What to log

The most important aspect of log management is choosing what to log. Organizations are different, and their logging requirements can differ too. It's important to consider which log sources are most likely to contain the most useful information depending on your event of interest.

##### The issue with overlogging

From a security perspective, it can be tempting to log everything. This is the most common mistake organizations make. Just because it can be logged, doesn't mean it needs to be logged. Storing excessive amounts of logs can have many disadvantages with some SIEM tools. Additionally, overlogging can increase the load on systems, which can cause performance issues and affect usability, making it difficult to search for and identify important events.

##### Log retention

Organizations might operate in industries with regulatory requirements. Organizations that operate in the following industries might need to modify their log management policy to meet regulatory requirements:

- Public sector industries, like the Federal Information Security Modernization Act (FISMA)

- Healthcare industries, like the Health Insurance Portability and Accountability Act of 1996 (HIPAA)

- Financial services industries, such as the Payment Card Industry Data Security Standard (PCI DSS), the Gramm-Leach-Bliley Act (GLBA), and the Sarbanes-Oxley Act of 2002 (SOX)

##### Log protection

Along with management and retention, the protection of logs is vital in maintaining log integrity. It’s not unusual for malicious actors to modify logs in attempts to mislead security teams and to even hide their activity.

Storing logs in a centralized log server is a way to maintain log integrity. When logs are generated, they get sent to a dedicated server instead of getting stored on a local machine. This makes it more difficult for attackers to access logs because there is a barrier between the attacker and the log location.

### Overview of log file formats

#### JavaScript Object Notation (JSON)

JavaScript Object Notation (JSON) is a file format that is used to store and transmit data. JSON is known for being lightweight and easy to read and write. It is used for transmitting data in web technologies and is also commonly used in cloud environments. JSON syntax is derived from JavaScript syntax. JSON contains components from JavaScript including:

##### Key-value pairs

A **key-value pair** is a set of data that represents two linked items: a key and its corresponding value. A key-value pair consists of a key followed by a colon, and then followed by a value.

##### Commas

Commas are used to separate data.

##### Double quotes

Double quotes are used to enclose text data, which is also known as a string, for example:  `"Alert": "Malware"`. Data that contains numbers is not enclosed in quotes, like this: `"Alert code": 1090`.

##### Curly brackets

Curly brackets enclose an **object**, which is a data type that stores data in a comma-separated list of key-value pairs. Objects are often used to describe multiple properties for a given key. JSON log entries start and end with a curly bracket. In this example, `User` is the object that contains multiple properties:

```JSON
"User":
{
    "id": "1234",
    "name": "user",
    "role": "engineer"
}
```

##### Square brackets

Square brackets are used to enclose an **array**, which is a data type that stores data in a comma-separated ordered list. Arrays are useful when you want to store data as an ordered collection, for example: `["Administrators", "Users", "Engineering"]`.

#### Syslog

Syslog is a standard for logging and transmitting data. It can be used to refer to any of its three different capabilities:

1. **Protocol**: The syslog protocol is used to transport logs to a centralized log server for log management. It uses port 514 for plaintext logs and port 6514 for encrypted logs.

2. **Service**: The syslog service acts as a log forwarding service that consolidates logs from multiple sources into a single location. The service works by receiving and then forwarding any syslog log entries to a remote server.

3. **Log format**: The syslog log format is one of the most commonly used log formats that you will be focusing on. It is the native logging format used in  Unix® systems. It consists of three components: a header, structured-data, and a message.

##### Syslog log example

```Syslog
<236>1 2022-03-21T01:11:11.003Z virtual.machine.com evntslog - ID01 [user@32473 iut="1" eventSource="Application" eventID="9999"]
This is a log entry!
```

**Header**

The header contains details like the timestamp; the hostname, which is the name of the machine that sends the log; the application name; and the message ID.

- **Timestamp**: The timestamp in this example is 2022-03-21T01:11:11.003Z, where 2022-03-21 is the date in YYYY-MM-DD format. T is used to separate the date and the time. 01:11:11.003 is the 24-hour format of the time and includes the number of milliseconds 003. Z indicates the timezone, which is Coordinated Universal Time (UTC).

- **Hostname**: virtual.machine.com

- **Application**: evntslog

- **Message ID**: ID01

**Structured-data**

The structured-data portion of the log entry contains additional logging information. This information is enclosed in square brackets and structured in key-value pairs. Here, there are three keys with corresponding values: `[user@32473 iut="1" eventSource="Application" eventID="9999"]`.

**Message**
The message contains a detailed log message about the event. Here, the message is `This is a log entry!`.

**Priority (PRI)**
The priority (PRI) field indicates the urgency of the logged event and is contained with angle brackets. In this example, the priority value is `<236>`. Generally, the lower the priority level, the more urgent the event is.

#### XML (eXtensible Markup Language)

XML (eXtensible Markup Language) is a language and a format used for storing and transmitting data. XML is a native file format used in Windows systems. XML syntax uses the following:

##### Tags

XML uses tags to store and identify data. Tags are pairs that must contain a start tag and an end tag.

##### Elements

XML elements include *both* the data contained inside of a tag and the tags itself. All XML entries must contain at least one root element. Root elements contain other elements that sit underneath them, known as child elements.

```XML
<Event>
    <EventID>4688</EventID>
    <Version>5</Version>
</Event>
```

In this example, `<Event>` is the root element and contains two child elements `<EventID>` and `<Version>`. There is data contained in each respective child element.

##### Attributes

XML elements can also contain attributes. Attributes are used to provide additional information about elements. Attributes are included as the second part of the tag itself and must always be quoted using either single or double quotes.

```XML
<EventData>
    <Data Name='SubjectUserSid'>S-2-3-11-160321</Data>
    <Data Name='SubjectUserName'>JSMITH</Data>
    <Data Name='SubjectDomainName'>ADCOMP</Data>
    <Data Name='SubjectLogonId'>0x1cf1c12</Data>
    <Data Name='NewProcessId'>0x1404</Data>
</EventData>
```

In the first line for this example, the tag is `<Data>` and it uses the attribute `Name='SubjectUserSid'` to describe the data enclosed in the tag `S-2-3-11-160321`.

#### CSV (Comma Separated Value)

CSV (Comma Separated Value) uses commas to separate data values. In CSV logs, the position of the data corresponds to its field name, but the field names themselves might not be included in the log. It’s critical to understand what fields the source device (like an IPS, firewall, scanner, etc.) is including in the log.

```CSV
2009-11-24T21:27:09.534255,ALERT,192.168.2.7, 1041,x.x.250.50,80,TCP,ALLOWED,1:2001999:9,"ET MALWARE BTGrab.com Spyware Downloading Ads",1
```

#### CEF (Common Event Format)

**Common Event Format (CEF)** is a log format that uses key-value pairs to structure data and identify fields and their corresponding values. The CEF syntax is defined as containing the following fields:

```CEF
CEF:Version|Device Vendor|Device Product|Device Version|Signature ID|Name|Severity|Extension
```

Fields are all separated with a pipe character `|`. However, anything in the `Extension` part of the CEF log entry must be written in a key-value format. Syslog is a common method used to transport logs like CEF. When Syslog is used a timestamp and hostname will be prepended to the CEF message. Here is an example of a CEF log entry that details malicious activity relating to a worm infection:

```CEF
Sep 29 08:26:10 host CEF:1|Security|threatmanager|1.0|100|worm successfully stopped|10|src=10.0.0.2 dst=2.1.2.2 spt=1232
```

Here is a breakdown of the fields:

- Syslog Timestamp: `Sep 29 08:26:10`

- Syslog Hostname: `host`

- Version: `CEF:1`

- Device Vendor: `Security`

- Device Product: `threatmanager`

- Device Version: `1.0`

- Signature ID: `100`

- Name: `worm successfully stopped`

- Severity: `10`

- Extension: This field contains data written as key-value pairs. There are two IP addresses, `src=10.0.0.2` and `dst=2.1.2.2`, and a source port number `spt=1232`. Extensions are not required and are optional to add.

This log entry contains details about a `Security` application called `threatmanager` that successfully `stopped a worm` from spreading from the internal network at `10.0.0.2` to the external network `2.1.2.2` through the port `1232`. A high severity level of `10` is reported.

## Overview of intrusion detection systems (IDS)

### Security monitoring with detection tools

Telemetry is the collection and transmission of data for analysis. While logs record events occurring on systems, telemetry describes the data itself.

An **endpoint** is any device connected on a network, such as a laptop, tablet, desktop computer, or a smartphone. Endpoints are entry points into a network, which makes them key targets for malicious actors looking to gain unauthorized access into a system.

To monitor endpoints for threats or attacks, a host-based intrusion detection system can be used. It's an application that monitors the activity of the host on which it's installed. A **host** is any device that communicates with other devices on a network, similar to an endpoint.

Before alerts are generated, the activity must be logged. IDS technologies record the information of the devices, systems, and networks which they monitor as IDS logs. IDS logs can then be sent, stored, and analyzed in a centralized log repository like a SIEM.

#### Host-based intrusion detection system (HIDS)

**Host-based intrusion detection systems** are installed as an agent on a single host, such as a laptop computer or a server. Depending on its configuration, host-based intrusion detection systems will monitor the host on which it's installed to detect suspicious activity.

HIDS agents are installed on all endpoints and used to monitor and detect security threats. A HIDS monitors internal activity happening on the host to identify any unauthorized or abnormal behavior. If anything unusual is detected, such as the installation of an unauthorized application, the HIDS logs it and sends out an alert.

#### Network-based intrusion detection system (NIDS)

A **network-based intrusion detection system** collects and analyzes network traffic and network data. Network-based intrusion detection systems work similar to packet sniffers because they analyze network traffic and network data on a specific point in the network.

It's common to deploy multiple IDS sensors at different points in the network to achieve adequate visibility. Using a combination of HIDS and NIDS to monitor an environment can provide a multi-layered approach to intrusion detection and response. HIDS and NIDS tools provide a different perspective on the activity occurring on a network and the individual hosts that are connected to it. This helps provide a comprehensive view of the activity happening in an environment.

#### Detection techniques

##### Signature-based analysis

Intrusion detection systems use different types of detection methods. One of the most common methods is signature analysis. **Signature analysis** is a detection method used to find events of interest. A **signature** specifies a set of rules that an IDS refers to when it monitors activity. If the activity matches the rules in the signature, the IDS logs it and sends out an alert. A signature is a pattern that is associated with malicious activity. Signatures can contain specific patterns like a sequence of binary numbers, bytes, or even specific data like an IP address.

Different types of signatures can be used depending on which type of threat or attack you want to detect.

**Advantages**

- **Low rate of false positives**: Signature-based analysis is very efficient at detecting known threats because it is simply comparing activity to signatures. This leads to fewer false positives.

**Disadvantages**

- **Signatures can be evaded**: Signatures are unique, and attackers can modify their attack behaviors to bypass the signatures.

- **Signatures require updates**: Signature-based analysis relies on a database of signatures to detect threats. Each time a new exploit or attack is discovered, new signatures must be created and added to the signature database.

- **Inability to detect unknown threats**: Signature-based analysis relies on detecting known threats through signatures. Unknown threats can't be detected, such as new malware families or zero-day attacks, which are exploits that were previously unknown.

##### Anomaly-based analysis

**Anomaly-based analysis** is a detection method that identifies abnormal behavior. There are two phases to anomaly-based analysis: a training phase and a detection phase. In the training phase, a baseline of normal or expected behavior must be established. Baselines are developed by collecting data that corresponds to normal system behavior. In the detection phase, the current system activity is compared against this baseline. Activity that happens outside of the baseline gets logged, and an alert is generated.

**Advantages**

- **Ability to detect new and evolving threats**: Unlike signature-based analysis, which uses known patterns to detect threats, anomaly-based analysis can detect unknown threats.

**Disadvantages**

- **High rate of false positives**: Any behavior that deviates from the baseline can be flagged as abnormal, including non-malicious behaviors. This leads to a high rate of false positives.

- **Pre-existing compromise**: The existence of an attacker during the training phase will include malicious behavior in the baseline. This can lead to missing a pre-existing attacker.

### Components of a detection signature

A signature specifies detection rules. These rules outline the types of network intrusions you want an IDS to detect. Rule language differs depending on different network intrusion detection systems.

The term network intrusion detection system is often abbreviated as the acronym **N-I-D-S** and pronounced **NIDS**. Generally, **NIDS** rules consists of three components: an action, a header, and rule options.

#### Action

This determines the action to take if the rule criteria matches are met. Actions differ across NIDS rule languages, but some common actions are: alert, pass, or reject.

#### Header

The header defines the signature's network traffic. These include information such as source and destination IP addresses, source and destination ports, protocols, and traffic direction.

#### Rule options

The rule options lets you customize signatures with additional parameters. There are many different options available to use. For instance, you can set options to match the content of a network packet to detect malicious payloads.

Configuring rule options helps in narrowing down network traffic, so you can find exactly what you're looking for. Typically, rule options are separated by semi-colons and enclosed in parentheses.

## Overview of security information event management (SIEM) tools

A **SIEM** is an application that collects and analyzes log data to monitor critical activities in an organization. It does this by collecting, analyzing, and reporting on security data from multiple sources.

### Log sources and log ingestion

#### Log ingestion

SIEM tools must first collect data using log ingestion. **Log ingestion** is the process of collecting and importing data from log sources into a SIEM tool.

In log ingestion, the SIEM creates a copy of the event data it receives and retains it within its own storage. This copy allows the SIEM to analyze and process the data without directly modifying the original source logs. The collection of event data provides a centralized platform for security analysts to analyze the data and respond to incidents.

##### Log forwarders

A common way that organizations collect log data is to use log forwarders. Log forwarders are software that automate the process of collecting and sending log data.

### Search methods with SIEM tools
